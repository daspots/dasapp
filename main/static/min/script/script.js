(function(){window.api_call=function(e,t,n,i,r){var o,s;r=r||i||n,i=i||n,4===arguments.length&&(i=void 0),3===arguments.length&&(n=void 0,i=void 0),n=n||{};for(o in n)null==n[o]&&delete n[o];return s=t.search("\\?")>=0?"&":"?",$.ajax({type:e,url:""+t+s+$.param(n),contentType:"application/json",accepts:"application/json",dataType:"json",data:i?JSON.stringify(i):void 0,success:function(t){var n;return"success"===t.status?(n=void 0,t.next_url&&(n=function(n){return api_call(e,t.next_url,{},n)}),"function"==typeof r?r(void 0,t.result,n):void 0):"function"==typeof r?r(t):void 0},error:function(e,t,n){var i;i={error_code:"ajax_error",text_status:t,error_thrown:n,jqXHR:e};try{e.responseText&&(i=$.parseJSON(e.responseText))}catch(e){e,i=i}return LOG("api_call error",i),"function"==typeof r?r(i):void 0}})}}).call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};window.FileUploader=function(){function n(t){var n,i;this.options=t,this.upload_file=e(this.upload_file,this),this.process_files=e(this.process_files,this),this.get_upload_urls=e(this.get_upload_urls,this),this.upload_files=e(this.upload_files,this),this.file_select_handler=e(this.file_select_handler,this),this.file_drag_hover=e(this.file_drag_hover,this),this.upload_handler=this.options.upload_handler,this.selector=this.options.selector,this.drop_area=this.options.drop_area,this.upload_url=this.options.upload_url||"/api/v1"+window.location.pathname,this.confirm_message=this.options.confirm_message||"Files are still being uploaded.",this.allowed_types=this.options.allowed_types,this.max_size=this.options.max_size,this.active_files=0,null!=(n=this.selector)&&n.bind("change",function(e){return function(t){return e.file_select_handler(t)}}(this)),i=new XMLHttpRequest,null!=this.drop_area&&i.upload&&(this.drop_area.on("dragover",this.file_drag_hover),this.drop_area.on("dragleave",this.file_drag_hover),this.drop_area.on("drop",function(e){return function(t){return e.file_select_handler(t)}}(this)),this.drop_area.show()),window.onbeforeunload=function(e){return function(){if(null!=e.confirm_message&&e.active_files>0)return e.confirm_message}}(this)}return n.prototype.file_drag_hover=function(e){if(null!=this.drop_area)return e.stopPropagation(),e.preventDefault(),"dragover"===e.type?this.drop_area.addClass("drag-hover"):this.drop_area.removeClass("drag-hover")},n.prototype.file_select_handler=function(e){var t,n,i,r;if(this.file_drag_hover(e),(null!=(t=(null!=(n=e.originalEvent.dataTransfer)?n.files:void 0)||(null!=(i=e.target)?i.files:void 0)||(null!=(r=e.dataTransfer)?r.files:void 0))?t.length:void 0)>0)return this.upload_files(t)},n.prototype.upload_files=function(e){return this.get_upload_urls(e.length,function(t){return function(n,i){if(!n)return t.process_files(e,i,0);console.log("Error getting URLs",n)}}(this))},n.prototype.get_upload_urls=function(e,t){if(!(e<=0))return api_call("GET",this.upload_url,{count:e},function(e,n){if(e)throw t(e),e;return t(void 0,n)})},n.prototype.process_files=function(e,t,n){var i;if(!(n>=e.length))return this.upload_file(e[n],t[n].upload_url,null!=(i=this.upload_handler)?i.preview(e[n]):void 0,function(i){return function(){return i.process_files(e,t,n+1,null!=i.upload_handler)}}(this))},n.prototype.upload_file=function(e,n,i,r){var o,s,a,u;return u=new XMLHttpRequest,(null!=(s=this.allowed_types)?s.length:void 0)>0&&(a=e.type,t.call(this.allowed_types,a)<0)?(i(0,void 0,"wrong_type"),void r()):null!=this.max_size&&e.size>this.max_size?(i(0,void 0,"too_big"),void r()):(u.upload.addEventListener("progress",function(e){return i(parseInt(e.loaded/e.total*100))}),u.onreadystatechange=function(e){return function(t){var n;if(4===u.readyState)return 200===u.status?(n=JSON.parse(u.responseText),i(100,n.result),$("#image").val($("#image").val()+n.result.id+";"),e.active_files-=1):(i(0,void 0,"error"),e.active_files-=1)}}(this),u.open("POST",n,!0),(o=new FormData).append("file",e),u.send(o),r())},n}()}.call(this),function(){window.LOG=function(){return"undefined"!=typeof console&&null!==console&&"function"==typeof console.log?console.log.apply(console,arguments):void 0},window.init_common=function(){return init_loading_button(),init_confirm_button(),init_password_show_button(),init_time(),init_announcement(),init_row_link()},window.init_loading_button=function(){return $("body").on("click",".btn-loading",function(){return $(this).button("loading")})},window.init_confirm_button=function(){return $("body").on("click",".btn-confirm",function(){if(!confirm($(this).data("message")||"Are you sure?"))return event.preventDefault()})},window.init_password_show_button=function(){return $("body").on("click",".btn-password-show",function(){var e;return(e=$($(this).data("target"))).focus(),$(this).hasClass("active")?e.attr("type","password"):e.attr("type","text")})},window.init_time=function(){if($("time").length>0)return function(){return $("time[datetime]").each(function(){var e;return e=moment.utc($(this).attr("datetime")),moment().diff(e,"days")>25?$(this).text(e.local().format("YYYY-MM-DD")):$(this).text(e.fromNow()),$(this).attr("title",e.local().format("dddd, MMMM Do YYYY, HH:mm:ss Z"))}),setTimeout(arguments.callee,45e3)}()},window.init_announcement=function(){if($(".alert-announcement button.close").click(function(){return"undefined"!=typeof sessionStorage&&null!==sessionStorage?sessionStorage.setItem("closedAnnouncement",$(".alert-announcement").html()):void 0}),("undefined"!=typeof sessionStorage&&null!==sessionStorage?sessionStorage.getItem("closedAnnouncement"):void 0)!==$(".alert-announcement").html())return $(".alert-announcement").show()},window.init_row_link=function(){return $("body").on("click",".row-link",function(){return window.location.href=$(this).data("href")}),$("body").on("click",".not-link",function(e){return e.stopPropagation()})},window.clear_notifications=function(){return $("#notifications").empty()},window.show_notification=function(e,t){if(null==t&&(t="warning"),clear_notifications(),e)return $("#notifications").append('<div class="alert alert-dismissable alert-'+t+'">\n  <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>\n  '+e+"\n</div>")},window.size_human=function(e){var t,n,i,r;for(t=0,n=(i=["B","KB","MB","GB","TB"]).length;t<n;t++){if(r=i[t],e<1e3)return"B"===r?e+" "+r:parseInt(10*e)/10+" "+r;e/=1024}}}.call(this),function(){$(function(){return init_common()}),$(function(){return $("html.auth").each(function(){return init_auth()})}),$(function(){return $("html.user-list").each(function(){return init_user_list()})}),$(function(){return $("html.user-merge").each(function(){return init_user_merge()})}),$(function(){return $("html.resource-list").each(function(){return init_resource_list()})}),$(function(){return $("html.resource-view").each(function(){return init_resource_view()})}),$(function(){return $("html.resource-upload").each(function(){return init_resource_upload()})})}.call(this),function(){window.init_auth=function(){return $(".remember").change(function(){var e,t,n,i,r,o;for(o=[],i=0,r=(t=$(".btn-social").toArray().concat($(".btn-social-icon").toArray())).length;i<r;i++)e=t[i],n=$(e).prop("href"),$(".remember input").is(":checked")?($(e).prop("href",n+"&remember=true"),o.push($("#remember").prop("checked",!0))):($(e).prop("href",n.replace("&remember=true","")),o.push($("#remember").prop("checked",!1)));return o}),$(".remember").change()}}.call(this),function(){$(".pretty-file").length&&$(".pretty-file").each(function(){var e,t;return t=$(this),(e=t.find('input[type="file"]')).hide(),e.change(function(){var n,i,r;return n=e[0].files,i="",i=n.length>1?n.length+" files selected":(r=e.val().split("\\"))[r.length-1],t.find(".input-group input").val(i)}),t.find(".input-group").click(function(t){return t.preventDefault(),e.click(),$(this).blur()})})}.call(this),function(){var e;window.init_resource_list=function(){return init_delete_resource_button()},window.init_resource_view=function(){return init_delete_resource_button()},window.init_resource_upload=function(){if(window.File&&window.FileList&&window.FileReader)return window.file_uploader=new FileUploader({upload_handler:e,selector:$(".file"),drop_area:$(".drop-area"),confirm_message:"Files are still being uploaded.",upload_url:$(".file").data("get-upload-url"),allowed_types:[],max_size:1073741824})},e={preview:function(e){var t,n,i;return n=$('<div class="col-lg-2 col-md-3 col-sm-4 col-xs-6">\n  <div class="thumbnail">\n    <div class="preview"></div>\n    <h5>'+e.name+'</h5>\n    <div class="progress">\n      <div class="progress-bar" style="width: 0%;"></div>\n      <div class="progress-text"></div>\n    </div>\n  </div>\n</div>'),t=$(".preview",n),file_uploader.active_files<16&&0===e.type.indexOf("image")?((i=new FileReader).onload=function(e){return t.css("background-image","url("+e.target.result+")")},i.readAsDataURL(e)):t.text(e.type||"application/octet-stream"),$(".resource-uploads").prepend(n),function(i,r,o){return o?($(".progress-bar",n).css("width","100%"),$(".progress-bar",n).addClass("progress-bar-danger"),void("too_big"===o?$(".progress-text",n).text("Failed! Too big, max: "+size_human(file_uploader.max_size)+"."):"wrong_type"===o?$(".progress-text",n).text("Failed! Wrong file type."):$(".progress-text",n).text("Failed!"))):100===i&&r?($(".progress-bar",n).addClass("progress-bar-success"),$(".progress-text",n).text("Success "+size_human(e.size)),r.image_url&&t.text().length>0?(t.css("background-image","url("+r.image_url+")"),t.text("")):void 0):100===i?($(".progress-bar",n).css("width","100%"),$(".progress-text",n).text("100% - Processing..")):($(".progress-bar",n).css("width",i+"%"),$(".progress-text",n).text(i+"% of "+size_human(e.size)))}}},window.init_delete_resource_button=function(){return $("body").on("click",".btn-delete",function(e){if(e.preventDefault(),confirm("Press OK to delete the resource"))return $(this).attr("disabled","disabled"),api_call("DELETE",$(this).data("api-url"),function(e){return function(t,n){var i,r;return t?($(e).removeAttr("disabled"),void LOG("Something went terribly wrong during delete!",t)):(r=$(e).data("target"),i=$(e).data("redirect-url"),r&&$(""+r).remove(),i?window.location.href=i:void 0)}}(this))})}}.call(this),function(){var e,t,n,i,r,o;window.init_user_list=function(){return n(),e(),t()},n=function(){return $("input[name=user_db]").each(function(){return o($(this))}),$("#select-all").change(function(){return $("input[name=user_db]").prop("checked",$(this).is(":checked")),$("input[name=user_db]").each(function(){return o($(this))})}),$("input[name=user_db]").change(function(){return o($(this))})},o=function(e){return r(),$("input[name=user_db]").each(function(){var t;return t=e.val(),$("#"+t).toggleClass("warning",e.is(":checked"))})},r=function(){var e;return e=$("input[name=user_db]:checked").length,$("#user-actions").toggleClass("hidden",0===e),$("#user-merge").toggleClass("hidden",e<2),0===e?($("#select-all").prop("indeterminate",!1),$("#select-all").prop("checked",!1)):0===$("input[name=user_db]:not(:checked)").length?($("#select-all").prop("indeterminate",!1),$("#select-all").prop("checked",!0)):$("#select-all").prop("indeterminate",!0)},e=function(){return $("#user-delete").click(function(e){var t,n,i,o,s;if(clear_notifications(),e.preventDefault(),t=$(this).data("confirm").replace("{users}",$("input[name=user_db]:checked").length),confirm(t))return s=[],$("input[name=user_db]:checked").each(function(){return $(this).attr("disabled",!0),s.push($(this).val())}),n=$(this).data("api-url"),o=$(this).data("success"),i=$(this).data("error"),api_call("DELETE",n,{user_keys:s.join(",")},function(e,t){return e?($("input[name=user_db]:disabled").removeAttr("disabled"),void show_notification(i.replace("{users}",s.length),"danger")):$("#"+t.join(", #")).fadeOut(function(){return $(this).remove(),r(),show_notification(o.replace("{users}",s.length),"success")})})})},window.init_user_merge=function(){var e,t;return t=$("#user_keys").val(),e=$(".api-url").data("api-url"),api_call("GET",e,{user_keys:t},function(e,t){if(!e)return window.user_dbs=t,$("input[name=user_db]").removeAttr("disabled");LOG("Something went terribly wrong")}),$("input[name=user_db]").change(function(e){var t;return t=$(e.currentTarget).val(),i(t)})},i=function(e){var t,n,i,r;for($(".user-row").removeClass("success").addClass("danger"),$("#"+e).removeClass("danger").addClass("success"),i=[],t=0,n=user_dbs.length;t<n;t++){if(r=user_dbs[t],e===r.key){$("input[name=user_key]").val(r.key),$("input[name=username]").val(r.username),$("input[name=name]").val(r.name),$("input[name=email]").val(r.email);break}i.push(void 0)}return i},t=function(){return $("#user-merge").click(function(e){var t,n;return e.preventDefault(),t=[],$("input[name=user_db]:checked").each(function(){return t.push($(this).val())}),n=$(this).data("user-merge-url"),window.location.href=n+"?user_keys="+t.join(",")})}}.call(this);