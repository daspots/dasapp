function followFunction(e,t){api_url="/api/v1/follow/"+t+"/",e.classList.contains("label-default")?e.classList.contains("not-logged-in")?($(".recommender").css({display:"none"}),$("#loginform").fadeIn()):(e.classList.remove("label-default"),e.classList.add("label-success"),e.innerHTML="FOLLOWING",$.ajax({url:api_url,type:"PUT",data:{},success:function(){}})):e.classList.contains("label-success")&&(e.classList.remove("label-success"),e.classList.add("label-default"),e.innerHTML="FOLLOW",$.ajax({url:api_url,type:"DELETE",success:function(e){}}))}function starFunction(e,t){api_url="/api/v1/star/"+t+"/",e.classList.contains("fa-star-o")?e.classList.contains("not-logged-in")?($("#restaurant").css({display:"none"}),$("#loginform").fadeIn()):(e.classList.remove("fa-star-o"),e.classList.add("fa-star"),$.ajax({url:api_url,type:"PUT",data:{},success:function(){}})):e.classList.contains("fa-star")&&(e.classList.remove("fa-star"),e.classList.add("fa-star-o"),$.ajax({url:api_url,type:"DELETE",success:function(e){}}))}(function(){window.api_call=function(e,t,n,i,r){var s,a;r=r||i||n,i=i||n,4===arguments.length&&(i=void 0),3===arguments.length&&(n=void 0,i=void 0),n=n||{};for(s in n)null==n[s]&&delete n[s];return a=t.search("\\?")>=0?"&":"?",$.ajax({type:e,url:""+t+a+$.param(n),contentType:"application/json",accepts:"application/json",dataType:"json",data:i?JSON.stringify(i):void 0,success:function(t){var n;return"success"===t.status?(n=void 0,t.next_url&&(n=function(n){return api_call(e,t.next_url,{},n)}),"function"==typeof r?r(void 0,t.result,n):void 0):"function"==typeof r?r(t):void 0},error:function(e,t,n){var i;i={error_code:"ajax_error",text_status:t,error_thrown:n,jqXHR:e};try{e.responseText&&(i=$.parseJSON(e.responseText))}catch(e){e,i=i}return LOG("api_call error",i),"function"==typeof r?r(i):void 0}})}}).call(this),function(){var e=function(e,t){return function(){return e.apply(t,arguments)}},t=[].indexOf||function(e){for(var t=0,n=this.length;t<n;t++)if(t in this&&this[t]===e)return t;return-1};window.FileUploader=function(){function n(t){var n,i;this.options=t,this.upload_file=e(this.upload_file,this),this.process_files=e(this.process_files,this),this.get_upload_urls=e(this.get_upload_urls,this),this.upload_files=e(this.upload_files,this),this.file_select_handler=e(this.file_select_handler,this),this.file_drag_hover=e(this.file_drag_hover,this),this.upload_handler=this.options.upload_handler,this.selector=this.options.selector,this.drop_area=this.options.drop_area,this.upload_url=this.options.upload_url||"/api/v1"+window.location.pathname,this.confirm_message=this.options.confirm_message||"Files are still being uploaded.",this.allowed_types=this.options.allowed_types,this.max_size=this.options.max_size,this.active_files=0,null!=(n=this.selector)&&n.bind("change",function(e){return function(t){return e.file_select_handler(t)}}(this)),i=new XMLHttpRequest,null!=this.drop_area&&i.upload&&(this.drop_area.on("dragover",this.file_drag_hover),this.drop_area.on("dragleave",this.file_drag_hover),this.drop_area.on("drop",function(e){return function(t){return e.file_select_handler(t)}}(this)),this.drop_area.show()),window.onbeforeunload=function(e){return function(){if(null!=e.confirm_message&&e.active_files>0)return e.confirm_message}}(this)}return n.prototype.file_drag_hover=function(e){if(null!=this.drop_area)return e.stopPropagation(),e.preventDefault(),"dragover"===e.type?this.drop_area.addClass("drag-hover"):this.drop_area.removeClass("drag-hover")},n.prototype.file_select_handler=function(e){var t,n,i,r;if(this.file_drag_hover(e),(null!=(t=(null!=(n=e.originalEvent.dataTransfer)?n.files:void 0)||(null!=(i=e.target)?i.files:void 0)||(null!=(r=e.dataTransfer)?r.files:void 0))?t.length:void 0)>0)return this.upload_files(t)},n.prototype.upload_files=function(e){return this.get_upload_urls(e.length,function(t){return function(n,i){if(!n)return t.process_files(e,i,0);console.log("Error getting URLs",n)}}(this))},n.prototype.get_upload_urls=function(e,t){if(!(e<=0))return api_call("GET",this.upload_url,{count:e},function(e,n){if(e)throw t(e),e;return t(void 0,n)})},n.prototype.process_files=function(e,t,n){var i;if(!(n>=e.length))return this.upload_file(e[n],t[n].upload_url,null!=(i=this.upload_handler)?i.preview(e[n]):void 0,function(i){return function(){return i.process_files(e,t,n+1,null!=i.upload_handler)}}(this))},n.prototype.upload_file=function(e,n,i,r){var s,a,o,l;return l=new XMLHttpRequest,(null!=(a=this.allowed_types)?a.length:void 0)>0&&(o=e.type,t.call(this.allowed_types,o)<0)?(i(0,void 0,"wrong_type"),void r()):null!=this.max_size&&e.size>this.max_size?(i(0,void 0,"too_big"),void r()):(l.upload.addEventListener("progress",function(e){return i(parseInt(e.loaded/e.total*100))}),l.onreadystatechange=function(e){return function(t){var n;if(4===l.readyState)return 200===l.status?(n=JSON.parse(l.responseText),i(100,n.result),$("#image").val($("#image").val()+n.result.id+";"),e.active_files-=1):(i(0,void 0,"error"),e.active_files-=1)}}(this),l.open("POST",n,!0),(s=new FormData).append("file",e),l.send(s),r())},n}()}.call(this),function(){window.LOG=function(){return"undefined"!=typeof console&&null!==console&&"function"==typeof console.log?console.log.apply(console,arguments):void 0},window.init_common=function(){return init_loading_button(),init_confirm_button(),init_password_show_button(),init_time(),init_announcement(),init_row_link()},window.init_loading_button=function(){return $("body").on("click",".btn-loading",function(){return $(this).button("loading")})},window.init_confirm_button=function(){return $("body").on("click",".btn-confirm",function(){if(!confirm($(this).data("message")||"Are you sure?"))return event.preventDefault()})},window.init_password_show_button=function(){return $("body").on("click",".btn-password-show",function(){var e;return(e=$($(this).data("target"))).focus(),$(this).hasClass("active")?e.attr("type","password"):e.attr("type","text")})},window.init_time=function(){if($("time").length>0)return function(){return $("time[datetime]").each(function(){var e;return e=moment.utc($(this).attr("datetime")),moment().diff(e,"days")>25?$(this).text(e.local().format("YYYY-MM-DD")):$(this).text(e.fromNow()),$(this).attr("title",e.local().format("dddd, MMMM Do YYYY, HH:mm:ss Z"))}),setTimeout(arguments.callee,45e3)}()},window.init_announcement=function(){if($(".alert-announcement button.close").click(function(){return"undefined"!=typeof sessionStorage&&null!==sessionStorage?sessionStorage.setItem("closedAnnouncement",$(".alert-announcement").html()):void 0}),("undefined"!=typeof sessionStorage&&null!==sessionStorage?sessionStorage.getItem("closedAnnouncement"):void 0)!==$(".alert-announcement").html())return $(".alert-announcement").show()},window.init_row_link=function(){return $("body").on("click",".row-link",function(){return window.location.href=$(this).data("href")}),$("body").on("click",".not-link",function(e){return e.stopPropagation()})},window.clear_notifications=function(){return $("#notifications").empty()},window.show_notification=function(e,t){if(null==t&&(t="warning"),clear_notifications(),e)return $("#notifications").append('<div class="alert alert-dismissable alert-'+t+'">\n  <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>\n  '+e+"\n</div>")},window.size_human=function(e){var t,n,i,r;for(t=0,n=(i=["B","KB","MB","GB","TB"]).length;t<n;t++){if(r=i[t],e<1e3)return"B"===r?e+" "+r:parseInt(10*e)/10+" "+r;e/=1024}}}.call(this),function(){$(function(){return init_common()}),$(function(){return $("html.auth").each(function(){return init_auth()})}),$(function(){return $("html.user-list").each(function(){return init_user_list()})}),$(function(){return $("html.user-merge").each(function(){return init_user_merge()})}),$(function(){return $("html.resource-list").each(function(){return init_resource_list()})}),$(function(){return $("html.resource-view").each(function(){return init_resource_view()})}),$(function(){return $("html.post-create").each(function(){return init_resource_upload()})})}.call(this),function(){window.init_auth=function(){return $(".remember").change(function(){var e,t,n,i,r,s;for(s=[],i=0,r=(t=$(".btn-social").toArray().concat($(".btn-social-icon").toArray())).length;i<r;i++)e=t[i],n=$(e).prop("href"),$(".remember input").is(":checked")?($(e).prop("href",n+"&remember=true"),s.push($("#remember").prop("checked",!0))):($(e).prop("href",n.replace("&remember=true","")),s.push($("#remember").prop("checked",!1)));return s}),$(".remember").change()}}.call(this),function(){$(".pretty-file").length&&$(".pretty-file").each(function(){var e,t;return t=$(this),(e=t.find('input[type="file"]')).hide(),e.change(function(){var n,i,r;return n=e[0].files,i="",i=n.length>1?n.length+" files selected":(r=e.val().split("\\"))[r.length-1],t.find(".input-group input").val(i)}),t.find(".input-group").click(function(t){return t.preventDefault(),e.click(),$(this).blur()})})}.call(this),function(){var e;window.init_resource_list=function(){return init_delete_resource_button()},window.init_resource_view=function(){return init_delete_resource_button()},window.init_resource_upload=function(){if(window.File&&window.FileList&&window.FileReader)return window.file_uploader=new FileUploader({upload_handler:e,selector:$(".file"),drop_area:$(".drop-area"),confirm_message:"Files are still being uploaded.",upload_url:$(".file").data("get-upload-url"),allowed_types:[],max_size:1073741824})},e={preview:function(e){var t,n,i;return n=$('<div class="col-lg-2 col-md-3 col-sm-4 col-xs-6">\n  <div class="thumbnail">\n    <div class="preview"></div>\n    <h5>'+e.name+'</h5>\n    <div class="progress">\n      <div class="progress-bar" style="width: 0%;"></div>\n      <div class="progress-text"></div>\n    </div>\n  </div>\n</div>'),t=$(".preview",n),file_uploader.active_files<16&&0===e.type.indexOf("image")?((i=new FileReader).onload=function(e){return t.css("background-image","url("+e.target.result+")")},i.readAsDataURL(e)):t.text(e.type||"application/octet-stream"),$(".resource-uploads").prepend(n),function(i,r,s){return s?($(".progress-bar",n).css("width","100%"),$(".progress-bar",n).addClass("progress-bar-danger"),void("too_big"===s?$(".progress-text",n).text("Failed! Too big, max: "+size_human(file_uploader.max_size)+"."):"wrong_type"===s?$(".progress-text",n).text("Failed! Wrong file type."):$(".progress-text",n).text("Failed!"))):100===i&&r?($(".progress-bar",n).addClass("progress-bar-success"),$(".progress-text",n).text("Success "+size_human(e.size)),r.image_url&&t.text().length>0?(t.css("background-image","url("+r.image_url+")"),t.text("")):void 0):100===i?($(".progress-bar",n).css("width","100%"),$(".progress-text",n).text("100% - Processing..")):($(".progress-bar",n).css("width",i+"%"),$(".progress-text",n).text(i+"% of "+size_human(e.size)))}}},window.init_delete_resource_button=function(){return $("body").on("click",".btn-delete",function(e){if(e.preventDefault(),confirm("Press OK to delete the resource"))return $(this).attr("disabled","disabled"),api_call("DELETE",$(this).data("api-url"),function(e){return function(t,n){var i,r;return t?($(e).removeAttr("disabled"),void LOG("Something went terribly wrong during delete!",t)):(r=$(e).data("target"),i=$(e).data("redirect-url"),r&&$(""+r).remove(),i?window.location.href=i:void 0)}}(this))})}}.call(this),function(){var e,t,n,i,r,s;window.init_user_list=function(){return n(),e(),t()},n=function(){return $("input[name=user_db]").each(function(){return s($(this))}),$("#select-all").change(function(){return $("input[name=user_db]").prop("checked",$(this).is(":checked")),$("input[name=user_db]").each(function(){return s($(this))})}),$("input[name=user_db]").change(function(){return s($(this))})},s=function(e){return r(),$("input[name=user_db]").each(function(){var t;return t=e.val(),$("#"+t).toggleClass("warning",e.is(":checked"))})},r=function(){var e;return e=$("input[name=user_db]:checked").length,$("#user-actions").toggleClass("hidden",0===e),$("#user-merge").toggleClass("hidden",e<2),0===e?($("#select-all").prop("indeterminate",!1),$("#select-all").prop("checked",!1)):0===$("input[name=user_db]:not(:checked)").length?($("#select-all").prop("indeterminate",!1),$("#select-all").prop("checked",!0)):$("#select-all").prop("indeterminate",!0)},e=function(){return $("#user-delete").click(function(e){var t,n,i,s,a;if(clear_notifications(),e.preventDefault(),t=$(this).data("confirm").replace("{users}",$("input[name=user_db]:checked").length),confirm(t))return a=[],$("input[name=user_db]:checked").each(function(){return $(this).attr("disabled",!0),a.push($(this).val())}),n=$(this).data("api-url"),s=$(this).data("success"),i=$(this).data("error"),api_call("DELETE",n,{user_keys:a.join(",")},function(e,t){return e?($("input[name=user_db]:disabled").removeAttr("disabled"),void show_notification(i.replace("{users}",a.length),"danger")):$("#"+t.join(", #")).fadeOut(function(){return $(this).remove(),r(),show_notification(s.replace("{users}",a.length),"success")})})})},window.init_user_merge=function(){var e,t;return t=$("#user_keys").val(),e=$(".api-url").data("api-url"),api_call("GET",e,{user_keys:t},function(e,t){if(!e)return window.user_dbs=t,$("input[name=user_db]").removeAttr("disabled");LOG("Something went terribly wrong")}),$("input[name=user_db]").change(function(e){var t;return t=$(e.currentTarget).val(),i(t)})},i=function(e){var t,n,i,r;for($(".user-row").removeClass("success").addClass("danger"),$("#"+e).removeClass("danger").addClass("success"),i=[],t=0,n=user_dbs.length;t<n;t++){if(r=user_dbs[t],e===r.key){$("input[name=user_key]").val(r.key),$("input[name=username]").val(r.username),$("input[name=name]").val(r.name),$("input[name=email]").val(r.email);break}i.push(void 0)}return i},t=function(){return $("#user-merge").click(function(e){var t,n;return e.preventDefault(),t=[],$("input[name=user_db]:checked").each(function(){return t.push($(this).val())}),n=$(this).data("user-merge-url"),window.location.href=n+"?user_keys="+t.join(",")})}}.call(this),$(".close-icon").on("click",function(){$(this).closest(".card").css({display:"none"}),$(".recommender").fadeIn()});var keywords=new Bloodhound({datumTokenizer:Bloodhound.tokenizers.obj.whitespace("name"),queryTokenizer:Bloodhound.tokenizers.whitespace,prefetch:{url:"/keywords",filter:function(e){return $.map(e,function(e){return{name:e}})}}});keywords.initialize(),$("#search").typeahead(null,{minlength:1,name:"keywords",displayKey:"name",valueKey:"name",source:keywords.ttAdapter()}),$("#search_page").typeahead(null,{minlength:1,name:"keywords",displayKey:"name",valueKey:"name",source:keywords.ttAdapter()}),$("#keywords").tagsinput({confirmKeys:[13,32,44],typeaheadjs:[{minLength:1,highlight:!0},{minlength:1,name:"keywords",displayKey:"name",valueKey:"name",source:keywords.ttAdapter()}],freeInput:!0}),$(document).ready(function(){localStorage.clear()}),$(".close-icon").on("click",function(){$(this).closest(".card").css({display:"none"}),$("#restaurant").fadeIn()})(function(e){"use strict";var t=function(t,n){var i=this,r={allowFreeEntries:!0,allowDuplicates:!1,ajaxConfig:{},autoSelect:!0,selectFirst:!1,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:!1,disabledField:null,displayField:"name",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(e){return"Please reduce your entry by "+e+" character"+(e>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(e){return"You cannot choose more than "+e+" item"+(e>1?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(e){return"Please type "+e+" more character"+(e>1?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:!1,resultAsString:!1,resultAsStringDelimiter:",",resultsField:"results",selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},s=e.extend({},n),a=e.extend(!0,{},r,s);this.addToSelection=function(t,n){if(!a.maxSelection||l.length<a.maxSelection){e.isArray(t)||(t=[t]);var r=!1;e.each(t,function(t,n){(a.allowDuplicates||-1===e.inArray(n[a.valueField],i.getValue()))&&(l.push(n),r=!0)}),!0===r&&(g._renderSelection(),this.empty(),!0!==n&&e(this).trigger("selectionchange",[this,this.getSelection()]))}this.input.attr("placeholder","inner"===a.selectionPosition&&this.getValue().length>0?"":a.placeholder)},this.clear=function(e){this.removeFromSelection(l.slice(0),e)},this.collapse=function(){!0===a.expanded&&(this.combobox.detach(),a.expanded=!1,e(this).trigger("collapse",[this]))},this.disable=function(){this.container.addClass("ms-ctn-disabled"),a.disabled=!0,i.input.attr("disabled",!0)},this.empty=function(){this.input.val("")},this.enable=function(){this.container.removeClass("ms-ctn-disabled"),a.disabled=!1,i.input.attr("disabled",!1)},this.expand=function(){!a.expanded&&(this.input.val().length>=a.minChars||this.combobox.children().size()>0)&&(this.combobox.appendTo(this.container),g._processSuggestions(),a.expanded=!0,e(this).trigger("expand",[this]))},this.isDisabled=function(){return a.disabled},this.isValid=function(){var t=!1===a.required||l.length>0;return(a.vtype||a.vregex)&&e.each(l,function(e,n){t=t&&g._validateSingleItem(n[a.valueField])}),t},this.getDataUrlParams=function(){return a.dataUrlParams},this.getName=function(){return a.name},this.getSelection=function(){return l},this.getRawValue=function(){return i.input.val()},this.getValue=function(){return e.map(l,function(e){return e[a.valueField]})},this.removeFromSelection=function(t,n){e.isArray(t)||(t=[t]);var r=!1;e.each(t,function(t,n){var s=e.inArray(n[a.valueField],i.getValue());s>-1&&(l.splice(s,1),r=!0)}),!0===r&&(g._renderSelection(),!0!==n&&e(this).trigger("selectionchange",[this,this.getSelection()]),a.expandOnFocus&&i.expand(),a.expanded&&g._processSuggestions()),this.input.attr("placeholder","inner"===a.selectionPosition&&this.getValue().length>0?"":a.placeholder)},this.getData=function(){return p},this.setData=function(e){a.data=e,g._processSuggestions()},this.setName=function(t){a.name=t,t&&(a.name+=t.indexOf("[]")>0?"":"[]"),i._valueContainer&&e.each(i._valueContainer.children(),function(e,t){t.name=a.name})},this.setSelection=function(e){this.clear(),this.addToSelection(e)},this.setValue=function(t){var n=[];e.each(t,function(t,i){var r=!1;if(e.each(p,function(e,t){if(t[a.valueField]==i)return n.push(t),r=!0,!1}),!r)if("object"==typeof i)n.push(i);else{var s={};s[a.valueField]=i,s[a.displayField]=i,n.push(s)}}),n.length>0&&this.addToSelection(n)},this.setDataUrlParams=function(t){a.dataUrlParams=e.extend({},t)};var o,l=[],c=0,u=!1,d=null,p=[],h=!1,m={BACKSPACE:8,TAB:9,ENTER:13,CTRL:17,ESC:27,SPACE:32,UPARROW:38,DOWNARROW:40,COMMA:188},g={_displaySuggestions:function(t){i.combobox.show(),i.combobox.empty();var n=0,r=0;if(null===d)g._renderComboItems(t),n=c*t.length;else{for(var s in d)r+=1,e("<div/>",{class:"ms-res-group",html:s}).appendTo(i.combobox),g._renderComboItems(d[s].items,!0);var o=i.combobox.find(".ms-res-group").outerHeight();if(null!==o){var l=r*o;n=c*t.length+l}else n=c*(t.length+r)}if(n<i.combobox.height()||n<=a.maxDropHeight?i.combobox.height(n):n>=i.combobox.height()&&n>a.maxDropHeight&&i.combobox.height(a.maxDropHeight),1===t.length&&!0===a.autoSelect&&i.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active"),!0===a.selectFirst&&i.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active"),0===t.length&&""!==i.getRawValue()){var u=a.noSuggestionText.replace(/\{\{.*\}\}/,i.input.val());g._updateHelper(u),i.collapse()}!1===a.allowFreeEntries&&(0===t.length?(e(i.input).addClass(a.invalidCls),i.combobox.hide()):e(i.input).removeClass(a.invalidCls))},_getEntriesFromStringArray:function(t){var n=[];return e.each(t,function(t,i){var r={};r[a.displayField]=r[a.valueField]=e.trim(i),n.push(r)}),n},_highlightSuggestion:function(t){var n=i.input.val(),r=["^","$","*","+","?",".","(",")",":","!","|","{","}","[","]"];if(e.each(r,function(e,t){n=n.replace(t,"\\"+t)}),0===n.length)return t;var s=!0===a.matchCase?"g":"gi";return t.replace(new RegExp("("+n+")(?!([^<]+)?>)",s),"<em>$1</em>")},_moveSelectedRow:function(e){a.expanded||i.expand();var t,n,r,s;t=i.combobox.find(".ms-res-item:not(.ms-res-item-disabled)"),n="down"===e?t.eq(0):t.filter(":last"),(r=i.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length>0&&("down"===e?(0===(n=r.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.eq(0)),s=i.combobox.scrollTop(),i.combobox.scrollTop(0),n[0].offsetTop+n.outerHeight()>i.combobox.height()&&i.combobox.scrollTop(s+c)):(0===(n=r.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.filter(":last"),i.combobox.scrollTop(c*t.length)),n[0].offsetTop<i.combobox.scrollTop()&&i.combobox.scrollTop(i.combobox.scrollTop()-c))),t.removeClass("ms-res-item-active"),n.addClass("ms-res-item-active")},_processSuggestions:function(t){var n=null,r=t||a.data;if(null!==r){if("function"==typeof r&&(r=r.call(i,i.getRawValue())),"string"==typeof r){e(i).trigger("beforeload",[i]);var s={};s[a.queryParam]=i.input.val();var o=e.extend(s,a.dataUrlParams);return void e.ajax(e.extend({type:a.method,url:r,data:o,beforeSend:a.beforeSend,success:function(t){n="string"==typeof t?JSON.parse(t):t,g._processSuggestions(n),e(i).trigger("load",[i,n]),g._asyncValues&&(i.setValue("string"==typeof g._asyncValues?JSON.parse(g._asyncValues):g._asyncValues),g._renderSelection(),delete g._asyncValues)},error:function(){throw"Could not reach server"}},a.ajaxConfig))}p=r.length>0&&"string"==typeof r[0]?g._getEntriesFromStringArray(r):r[a.resultsField]||r;var l="remote"===a.mode?p:g._sortAndTrim(p);g._displaySuggestions(g._group(l))}},_render:function(t){if(i.setName(a.name),i.container=e("<div/>",{class:"ms-ctn form-control "+(a.resultAsString?"ms-as-string ":"")+a.cls+(e(t).hasClass("input-lg")?" input-lg":"")+(e(t).hasClass("input-sm")?" input-sm":"")+(!0===a.disabled?" ms-ctn-disabled":"")+(!0===a.editable?"":" ms-ctn-readonly")+(!1===a.hideTrigger?"":" ms-no-trigger"),style:a.style,id:a.id}),i.container.focus(e.proxy(f._onFocus,this)),i.container.blur(e.proxy(f._onBlur,this)),i.container.keydown(e.proxy(f._onKeyDown,this)),i.container.keyup(e.proxy(f._onKeyUp,this)),i.input=e("<input/>",e.extend({type:"text",class:!0===a.editable?"":" ms-input-readonly",readonly:!a.editable,placeholder:a.placeholder,disabled:a.disabled},a.inputCfg)),i.input.focus(e.proxy(f._onInputFocus,this)),i.input.click(e.proxy(f._onInputClick,this)),i.combobox=e("<div/>",{class:"ms-res-ctn dropdown-menu"}).height(a.maxDropHeight),i.combobox.on("click","div.ms-res-item",e.proxy(f._onComboItemSelected,this)),i.combobox.on("mouseover","div.ms-res-item",e.proxy(f._onComboItemMouseOver,this)),a.selectionContainer?(i.selectionContainer=a.selectionContainer,e(i.selectionContainer).addClass("ms-sel-ctn")):i.selectionContainer=e("<div/>",{class:"ms-sel-ctn"}),i.selectionContainer.click(e.proxy(f._onFocus,this)),"inner"!==a.selectionPosition||a.selectionContainer?i.container.append(i.input):i.selectionContainer.append(i.input),i.helper=e("<span/>",{class:"ms-helper "+a.infoMsgCls}),g._updateHelper(),i.container.append(i.helper),e(t).replaceWith(i.container),!a.selectionContainer)switch(a.selectionPosition){case"bottom":i.selectionContainer.insertAfter(i.container),!0===a.selectionStacked&&(i.selectionContainer.width(i.container.width()),i.selectionContainer.addClass("ms-stacked"));break;case"right":i.selectionContainer.insertAfter(i.container),i.container.css("float","left");break;default:i.container.append(i.selectionContainer)}!1===a.hideTrigger&&(i.trigger=e("<div/>",{class:"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),i.trigger.click(e.proxy(f._onTriggerClick,this)),i.container.append(i.trigger)),e(window).resize(e.proxy(f._onWindowResized,this)),null===a.value&&null===a.data||("string"==typeof a.data?(g._asyncValues=a.value,g._processSuggestions()):(g._processSuggestions(),null!==a.value&&(i.setValue(a.value),g._renderSelection()))),e("body").click(function(e){i.container.hasClass("ms-ctn-focus")&&0===i.container.has(e.target).length&&e.target.className.indexOf("ms-res-item")<0&&e.target.className.indexOf("ms-close-btn")<0&&i.container[0]!==e.target&&f._onBlur()}),!0===a.expanded&&(a.expanded=!1,i.expand())},_renderComboItems:function(t,n){var r=this,s="";e.each(t,function(t,i){var o=null!==a.renderer?a.renderer.call(r,i):i[a.displayField],l=null!==a.disabledField&&!0===i[a.disabledField],c=e("<div/>",{class:"ms-res-item "+(n?"ms-res-item-grouped ":"")+(l?"ms-res-item-disabled ":"")+(t%2==1&&!0===a.useZebraStyle?"ms-res-odd":""),html:!0===a.highlight?g._highlightSuggestion(o):o,"data-json":JSON.stringify(i)});s+=e("<div/>").append(c).html()}),i.combobox.append(s),c=i.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var t=this,n=0,r=0,s=[],o=!0===a.resultAsString&&!u;i.selectionContainer.find(".ms-sel-item").remove(),void 0!==i._valueContainer&&i._valueContainer.remove(),e.each(l,function(n,i){var r,c=null!==a.selectionRenderer?a.selectionRenderer.call(t,i):i[a.displayField],u=g._validateSingleItem(i[a.displayField])?"":" ms-sel-invalid";!0===o?r=e("<div/>",{class:"ms-sel-item ms-sel-text "+a.selectionCls+u,html:c+(n===l.length-1?"":a.resultAsStringDelimiter)}).data("json",i):(r=e("<div/>",{class:"ms-sel-item "+a.selectionCls+u,html:c}).data("json",i),!1===a.disabled&&e("<span/>",{class:"ms-close-btn"}).data("json",i).appendTo(r).click(e.proxy(f._onTagTriggerClick,t))),s.push(r)}),i.selectionContainer.prepend(s),i._valueContainer=e("<div/>",{style:"display: none;"}),e.each(i.getValue(),function(t,n){e("<input/>",{type:"hidden",name:a.name,value:n}).appendTo(i._valueContainer)}),i._valueContainer.appendTo(i.selectionContainer),"inner"!==a.selectionPosition||a.selectionContainer||(i.input.width(0),r=i.input.offset().left-i.selectionContainer.offset().left,n=i.container.width()-r-42,i.input.width(n)),l.length===a.maxSelection?g._updateHelper(a.maxSelectionRenderer.call(this,l.length)):i.helper.hide()},_selectItem:function(e){1===a.maxSelection&&(l=[]),i.addToSelection(e.data("json")),e.removeClass("ms-res-item-active"),!1!==a.expandOnFocus&&l.length!==a.maxSelection||i.collapse(),u?u&&(a.expandOnFocus||h)&&(g._processSuggestions(),h&&i.expand()):i.input.focus()},_sortAndTrim:function(t){var n=i.getRawValue(),r=[],s=[],o=i.getValue();return n.length>0?e.each(t,function(e,t){var i=t[a.displayField];(!0===a.matchCase&&i.indexOf(n)>-1||!1===a.matchCase&&i.toLowerCase().indexOf(n.toLowerCase())>-1)&&(!1!==a.strictSuggest&&0!==i.toLowerCase().indexOf(n.toLowerCase())||r.push(t))}):r=t,e.each(r,function(t,n){(a.allowDuplicates||-1===e.inArray(n[a.valueField],o))&&s.push(n)}),null!==a.sortOrder&&s.sort(function(e,t){return e[a.sortOrder]<t[a.sortOrder]?"asc"===a.sortDir?-1:1:e[a.sortOrder]>t[a.sortOrder]?"asc"===a.sortDir?1:-1:0}),a.maxSuggestions&&a.maxSuggestions>0&&(s=s.slice(0,a.maxSuggestions)),s},_group:function(t){return null!==a.groupBy&&(d={},e.each(t,function(e,t){var n=a.groupBy.indexOf(".")>-1?a.groupBy.split("."):a.groupBy,i=t[a.groupBy];if("string"!=typeof n)for(i=t;n.length>0;)i=i[n.shift()];void 0===d[i]?d[i]={title:i,items:[t]}:d[i].items.push(t)})),t},_updateHelper:function(e){i.helper.html(e),i.helper.is(":visible")||i.helper.fadeIn()},_validateSingleItem:function(e){if(null!==a.vregex&&a.vregex instanceof RegExp)return a.vregex.test(e);if(null!==a.vtype)switch(a.vtype){case"alpha":return/^[a-zA-Z_]+$/.test(e);case"alphanum":return/^[a-zA-Z0-9_]+$/.test(e);case"email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(e);case"url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(e);case"ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(e)}return!0}},f={_onBlur:function(){if(i.container.removeClass("ms-ctn-focus"),i.collapse(),u=!1,""!==i.getRawValue()&&!0===a.allowFreeEntries){var t={};t[a.displayField]=t[a.valueField]=i.getRawValue().trim(),i.addToSelection(t)}g._renderSelection(),!1===i.isValid()?i.container.addClass(a.invalidCls):""!==i.input.val()&&!1===a.allowFreeEntries&&(i.empty(),g._updateHelper("")),e(i).trigger("blur",[i])},_onComboItemMouseOver:function(t){var n=e(t.currentTarget);n.hasClass("ms-res-item-disabled")||(i.combobox.children().removeClass("ms-res-item-active"),n.addClass("ms-res-item-active"))},_onComboItemSelected:function(t){e(t.currentTarget).hasClass("ms-res-item-disabled")||g._selectItem(e(t.currentTarget))},_onFocus:function(){i.input.focus()},_onInputClick:function(){!1===i.isDisabled()&&u&&!0===a.toggleOnClick&&(a.expanded?i.collapse():i.expand())},_onInputFocus:function(){if(!1===i.isDisabled()&&!u){u=!0,i.container.addClass("ms-ctn-focus"),i.container.removeClass(a.invalidCls);var t=i.getRawValue().length;!0===a.expandOnFocus&&i.expand(),l.length===a.maxSelection?g._updateHelper(a.maxSelectionRenderer.call(this,l.length)):t<a.minChars&&g._updateHelper(a.minCharsRenderer.call(this,a.minChars-t)),g._renderSelection(),e(i).trigger("focus",[i])}},_onKeyDown:function(t){var n=i.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),r=i.input.val();if(e(i).trigger("keydown",[i,t]),t.keyCode!==m.TAB||!1!==a.useTabKey&&(!0!==a.useTabKey||0!==n.length||0!==i.input.val().length))switch(t.keyCode){case m.BACKSPACE:0===r.length&&i.getSelection().length>0&&"inner"===a.selectionPosition&&(l.pop(),g._renderSelection(),e(i).trigger("selectionchange",[i,i.getSelection()]),i.input.attr("placeholder","inner"===a.selectionPosition&&i.getValue().length>0?"":a.placeholder),i.input.focus(),t.preventDefault());break;case m.TAB:case m.ESC:t.preventDefault();break;case m.ENTER:(""!==r||a.expanded)&&t.preventDefault();break;case m.COMMA:!0===a.useCommaKey&&t.preventDefault();break;case m.CTRL:h=!0;break;case m.DOWNARROW:t.preventDefault(),g._moveSelectedRow("down");break;case m.UPARROW:t.preventDefault(),g._moveSelectedRow("up");break;default:l.length===a.maxSelection&&t.preventDefault()}else f._onBlur()},_onKeyUp:function(t){var n,r=i.getRawValue(),s=e.trim(i.input.val()).length>0&&(!a.maxEntryLength||e.trim(i.input.val()).length<=a.maxEntryLength),c={};if(e(i).trigger("keyup",[i,t]),clearTimeout(o),t.keyCode===m.ESC&&a.expanded&&i.combobox.hide(),t.keyCode===m.TAB&&!1===a.useTabKey||t.keyCode>m.ENTER&&t.keyCode<m.SPACE)t.keyCode===m.CTRL&&(h=!1);else switch(t.keyCode){case m.UPARROW:case m.DOWNARROW:t.preventDefault();break;case m.ENTER:case m.TAB:case m.COMMA:if(t.keyCode!==m.COMMA||!0===a.useCommaKey){if(t.preventDefault(),!0===a.expanded&&(n=i.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length>0)return void g._selectItem(n);!0===s&&!0===a.allowFreeEntries&&(c[a.displayField]=c[a.valueField]=r.trim(),i.addToSelection(c),i.collapse(),i.input.focus());break}default:l.length===a.maxSelection?g._updateHelper(a.maxSelectionRenderer.call(this,l.length)):r.length<a.minChars?(g._updateHelper(a.minCharsRenderer.call(this,a.minChars-r.length)),!0===a.expanded&&i.collapse()):a.maxEntryLength&&r.length>a.maxEntryLength?(g._updateHelper(a.maxEntryRenderer.call(this,r.length-a.maxEntryLength)),!0===a.expanded&&i.collapse()):(i.helper.hide(),a.minChars<=r.length&&(o=setTimeout(function(){!0===a.expanded?g._processSuggestions():i.expand()},a.typeDelay)))}},_onTagTriggerClick:function(t){i.removeFromSelection(e(t.currentTarget).data("json"))},_onTriggerClick:function(){if(!1===i.isDisabled()&&(!0!==a.expandOnFocus||l.length!==a.maxSelection))if(e(i).trigger("triggerclick",[i]),!0===a.expanded)i.collapse();else{var t=i.getRawValue().length;t>=a.minChars?(i.input.focus(),i.expand()):g._updateHelper(a.minCharsRenderer.call(this,a.minChars-t))}},_onWindowResized:function(){g._renderSelection()}};null!==t&&g._render(t)};e.fn.magicSuggest=function(n){var i=e(this);return 1===i.size()&&i.data("magicSuggest")?i.data("magicSuggest"):(i.each(function(i){var r=e(this);if(!r.data("magicSuggest")){"select"===this.nodeName.toLowerCase()&&(n.data=[],n.value=[],e.each(this.children,function(t,i){i.nodeName&&"option"===i.nodeName.toLowerCase()&&(n.data.push({id:i.value,name:i.text}),e(i).attr("selected")&&n.value.push(i.value))}));var s={};e.each(this.attributes,function(e,t){s[t.name]="value"===t.name&&""!==t.value?JSON.parse(t.value):t.value});var a=new t(this,e.extend([],e.fn.magicSuggest.defaults,n,s));r.data("magicSuggest",a),a.container.data("magicSuggest",a)}}),1===i.size()?i.data("magicSuggest"):i)},e.fn.magicSuggest.defaults={}})(jQuery),function(e){"use strict";var t=function(t,n){var i=this,r={allowFreeEntries:!0,allowDuplicates:!1,ajaxConfig:{},autoSelect:!0,selectFirst:!1,queryParam:"query",beforeSend:function(){},cls:"",data:null,dataUrlParams:{},disabled:!1,disabledField:null,displayField:"name",editable:!0,expanded:!1,expandOnFocus:!1,groupBy:null,hideTrigger:!1,highlight:!0,id:null,infoMsgCls:"",inputCfg:{},invalidCls:"ms-inv",matchCase:!1,maxDropHeight:290,maxEntryLength:null,maxEntryRenderer:function(e){return"Please reduce your entry by "+e+" character"+(e>1?"s":"")},maxSuggestions:null,maxSelection:10,maxSelectionRenderer:function(e){return"You cannot choose more than "+e+" item"+(e>1?"s":"")},method:"POST",minChars:0,minCharsRenderer:function(e){return"Please type "+e+" more character"+(e>1?"s":"")},mode:"local",name:null,noSuggestionText:"No suggestions",placeholder:"Type or click here",renderer:null,required:!1,resultAsString:!1,resultAsStringDelimiter:",",resultsField:"results",selectionCls:"",selectionContainer:null,selectionPosition:"inner",selectionRenderer:null,selectionStacked:!1,sortDir:"asc",sortOrder:null,strictSuggest:!1,style:"",toggleOnClick:!1,typeDelay:400,useTabKey:!1,useCommaKey:!0,useZebraStyle:!1,value:null,valueField:"id",vregex:null,vtype:null},s=e.extend({},n),a=e.extend(!0,{},r,s);this.addToSelection=function(t,n){if(!a.maxSelection||l.length<a.maxSelection){e.isArray(t)||(t=[t]);var r=!1;e.each(t,function(t,n){(a.allowDuplicates||-1===e.inArray(n[a.valueField],i.getValue()))&&(l.push(n),r=!0)}),!0===r&&(g._renderSelection(),this.empty(),!0!==n&&e(this).trigger("selectionchange",[this,this.getSelection()]))}this.input.attr("placeholder","inner"===a.selectionPosition&&this.getValue().length>0?"":a.placeholder)},this.clear=function(e){this.removeFromSelection(l.slice(0),e)},this.collapse=function(){!0===a.expanded&&(this.combobox.detach(),a.expanded=!1,e(this).trigger("collapse",[this]))},this.disable=function(){this.container.addClass("ms-ctn-disabled"),a.disabled=!0,i.input.attr("disabled",!0)},this.empty=function(){this.input.val("")},this.enable=function(){this.container.removeClass("ms-ctn-disabled"),a.disabled=!1,i.input.attr("disabled",!1)},this.expand=function(){!a.expanded&&(this.input.val().length>=a.minChars||this.combobox.children().size()>0)&&(this.combobox.appendTo(this.container),g._processSuggestions(),a.expanded=!0,e(this).trigger("expand",[this]))},this.isDisabled=function(){return a.disabled},this.isValid=function(){var t=!1===a.required||l.length>0;return(a.vtype||a.vregex)&&e.each(l,function(e,n){t=t&&g._validateSingleItem(n[a.valueField])}),t},this.getDataUrlParams=function(){return a.dataUrlParams},this.getName=function(){return a.name},this.getSelection=function(){return l},this.getRawValue=function(){return i.input.val()},this.getValue=function(){return e.map(l,function(e){return e[a.valueField]})},this.removeFromSelection=function(t,n){e.isArray(t)||(t=[t]);var r=!1;e.each(t,function(t,n){var s=e.inArray(n[a.valueField],i.getValue());s>-1&&(l.splice(s,1),r=!0)}),!0===r&&(g._renderSelection(),!0!==n&&e(this).trigger("selectionchange",[this,this.getSelection()]),a.expandOnFocus&&i.expand(),a.expanded&&g._processSuggestions()),this.input.attr("placeholder","inner"===a.selectionPosition&&this.getValue().length>0?"":a.placeholder)},this.getData=function(){return p},this.setData=function(e){a.data=e,g._processSuggestions()},this.setName=function(t){a.name=t,t&&(a.name+=t.indexOf("[]")>0?"":"[]"),i._valueContainer&&e.each(i._valueContainer.children(),function(e,t){t.name=a.name})},this.setSelection=function(e){this.clear(),this.addToSelection(e)},this.setValue=function(t){var n=[];e.each(t,function(t,i){var r=!1;if(e.each(p,function(e,t){if(t[a.valueField]==i)return n.push(t),r=!0,!1}),!r)if("object"==typeof i)n.push(i);else{var s={};s[a.valueField]=i,s[a.displayField]=i,n.push(s)}}),n.length>0&&this.addToSelection(n)},this.setDataUrlParams=function(t){a.dataUrlParams=e.extend({},t)};var o,l=[],c=0,u=!1,d=null,p=[],h=!1,m={BACKSPACE:8,TAB:9,ENTER:13,CTRL:17,ESC:27,SPACE:32,UPARROW:38,DOWNARROW:40,COMMA:188},g={_displaySuggestions:function(t){i.combobox.show(),i.combobox.empty();var n=0,r=0;if(null===d)g._renderComboItems(t),n=c*t.length;else{for(var s in d)r+=1,e("<div/>",{class:"ms-res-group",html:s}).appendTo(i.combobox),g._renderComboItems(d[s].items,!0);var o=i.combobox.find(".ms-res-group").outerHeight();if(null!==o){var l=r*o;n=c*t.length+l}else n=c*(t.length+r)}if(n<i.combobox.height()||n<=a.maxDropHeight?i.combobox.height(n):n>=i.combobox.height()&&n>a.maxDropHeight&&i.combobox.height(a.maxDropHeight),1===t.length&&!0===a.autoSelect&&i.combobox.children().filter(":not(.ms-res-item-disabled):last").addClass("ms-res-item-active"),!0===a.selectFirst&&i.combobox.children().filter(":not(.ms-res-item-disabled):first").addClass("ms-res-item-active"),0===t.length&&""!==i.getRawValue()){var u=a.noSuggestionText.replace(/\{\{.*\}\}/,i.input.val());g._updateHelper(u),i.collapse()}!1===a.allowFreeEntries&&(0===t.length?(e(i.input).addClass(a.invalidCls),i.combobox.hide()):e(i.input).removeClass(a.invalidCls))},_getEntriesFromStringArray:function(t){var n=[];return e.each(t,function(t,i){var r={};r[a.displayField]=r[a.valueField]=e.trim(i),n.push(r)}),n},_highlightSuggestion:function(t){var n=i.input.val(),r=["^","$","*","+","?",".","(",")",":","!","|","{","}","[","]"];if(e.each(r,function(e,t){n=n.replace(t,"\\"+t)}),0===n.length)return t;var s=!0===a.matchCase?"g":"gi";return t.replace(new RegExp("("+n+")(?!([^<]+)?>)",s),"<em>$1</em>")},_moveSelectedRow:function(e){a.expanded||i.expand();var t,n,r,s;t=i.combobox.find(".ms-res-item:not(.ms-res-item-disabled)"),n="down"===e?t.eq(0):t.filter(":last"),(r=i.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length>0&&("down"===e?(0===(n=r.nextAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.eq(0)),s=i.combobox.scrollTop(),i.combobox.scrollTop(0),n[0].offsetTop+n.outerHeight()>i.combobox.height()&&i.combobox.scrollTop(s+c)):(0===(n=r.prevAll(".ms-res-item:not(.ms-res-item-disabled)").first()).length&&(n=t.filter(":last"),i.combobox.scrollTop(c*t.length)),n[0].offsetTop<i.combobox.scrollTop()&&i.combobox.scrollTop(i.combobox.scrollTop()-c))),t.removeClass("ms-res-item-active"),n.addClass("ms-res-item-active")},_processSuggestions:function(t){var n=null,r=t||a.data;if(null!==r){if("function"==typeof r&&(r=r.call(i,i.getRawValue())),"string"==typeof r){e(i).trigger("beforeload",[i]);var s={};s[a.queryParam]=i.input.val();var o=e.extend(s,a.dataUrlParams);return void e.ajax(e.extend({type:a.method,url:r,data:o,beforeSend:a.beforeSend,success:function(t){n="string"==typeof t?JSON.parse(t):t,g._processSuggestions(n),e(i).trigger("load",[i,n]),g._asyncValues&&(i.setValue("string"==typeof g._asyncValues?JSON.parse(g._asyncValues):g._asyncValues),g._renderSelection(),delete g._asyncValues)},error:function(){throw"Could not reach server"}},a.ajaxConfig))}p=r.length>0&&"string"==typeof r[0]?g._getEntriesFromStringArray(r):r[a.resultsField]||r;var l="remote"===a.mode?p:g._sortAndTrim(p);g._displaySuggestions(g._group(l))}},_render:function(t){if(i.setName(a.name),i.container=e("<div/>",{class:"ms-ctn form-control "+(a.resultAsString?"ms-as-string ":"")+a.cls+(e(t).hasClass("input-lg")?" input-lg":"")+(e(t).hasClass("input-sm")?" input-sm":"")+(!0===a.disabled?" ms-ctn-disabled":"")+(!0===a.editable?"":" ms-ctn-readonly")+(!1===a.hideTrigger?"":" ms-no-trigger"),style:a.style,id:a.id}),i.container.focus(e.proxy(f._onFocus,this)),i.container.blur(e.proxy(f._onBlur,this)),i.container.keydown(e.proxy(f._onKeyDown,this)),i.container.keyup(e.proxy(f._onKeyUp,this)),i.input=e("<input/>",e.extend({type:"text",class:!0===a.editable?"":" ms-input-readonly",readonly:!a.editable,placeholder:a.placeholder,disabled:a.disabled},a.inputCfg)),i.input.focus(e.proxy(f._onInputFocus,this)),i.input.click(e.proxy(f._onInputClick,this)),i.combobox=e("<div/>",{class:"ms-res-ctn dropdown-menu"}).height(a.maxDropHeight),i.combobox.on("click","div.ms-res-item",e.proxy(f._onComboItemSelected,this)),i.combobox.on("mouseover","div.ms-res-item",e.proxy(f._onComboItemMouseOver,this)),a.selectionContainer?(i.selectionContainer=a.selectionContainer,e(i.selectionContainer).addClass("ms-sel-ctn")):i.selectionContainer=e("<div/>",{class:"ms-sel-ctn"}),i.selectionContainer.click(e.proxy(f._onFocus,this)),"inner"!==a.selectionPosition||a.selectionContainer?i.container.append(i.input):i.selectionContainer.append(i.input),i.helper=e("<span/>",{class:"ms-helper "+a.infoMsgCls}),g._updateHelper(),i.container.append(i.helper),e(t).replaceWith(i.container),!a.selectionContainer)switch(a.selectionPosition){case"bottom":i.selectionContainer.insertAfter(i.container),!0===a.selectionStacked&&(i.selectionContainer.width(i.container.width()),i.selectionContainer.addClass("ms-stacked"));break;case"right":i.selectionContainer.insertAfter(i.container),i.container.css("float","left");break;default:i.container.append(i.selectionContainer)}!1===a.hideTrigger&&(i.trigger=e("<div/>",{class:"ms-trigger",html:'<div class="ms-trigger-ico"></div>'}),i.trigger.click(e.proxy(f._onTriggerClick,this)),i.container.append(i.trigger)),e(window).resize(e.proxy(f._onWindowResized,this)),null===a.value&&null===a.data||("string"==typeof a.data?(g._asyncValues=a.value,g._processSuggestions()):(g._processSuggestions(),null!==a.value&&(i.setValue(a.value),g._renderSelection()))),e("body").click(function(e){i.container.hasClass("ms-ctn-focus")&&0===i.container.has(e.target).length&&e.target.className.indexOf("ms-res-item")<0&&e.target.className.indexOf("ms-close-btn")<0&&i.container[0]!==e.target&&f._onBlur()}),!0===a.expanded&&(a.expanded=!1,i.expand())},_renderComboItems:function(t,n){var r=this,s="";e.each(t,function(t,i){var o=null!==a.renderer?a.renderer.call(r,i):i[a.displayField],l=null!==a.disabledField&&!0===i[a.disabledField],c=e("<div/>",{class:"ms-res-item "+(n?"ms-res-item-grouped ":"")+(l?"ms-res-item-disabled ":"")+(t%2==1&&!0===a.useZebraStyle?"ms-res-odd":""),html:!0===a.highlight?g._highlightSuggestion(o):o,"data-json":JSON.stringify(i)});s+=e("<div/>").append(c).html()}),i.combobox.append(s),c=i.combobox.find(".ms-res-item:first").outerHeight()},_renderSelection:function(){var t=this,n=0,r=0,s=[],o=!0===a.resultAsString&&!u;i.selectionContainer.find(".ms-sel-item").remove(),void 0!==i._valueContainer&&i._valueContainer.remove(),e.each(l,function(n,i){var r,c=null!==a.selectionRenderer?a.selectionRenderer.call(t,i):i[a.displayField],u=g._validateSingleItem(i[a.displayField])?"":" ms-sel-invalid";!0===o?r=e("<div/>",{class:"ms-sel-item ms-sel-text "+a.selectionCls+u,html:c+(n===l.length-1?"":a.resultAsStringDelimiter)}).data("json",i):(r=e("<div/>",{class:"ms-sel-item "+a.selectionCls+u,html:c}).data("json",i),!1===a.disabled&&e("<span/>",{class:"ms-close-btn"}).data("json",i).appendTo(r).click(e.proxy(f._onTagTriggerClick,t))),s.push(r)}),i.selectionContainer.prepend(s),i._valueContainer=e("<div/>",{style:"display: none;"}),e.each(i.getValue(),function(t,n){e("<input/>",{type:"hidden",name:a.name,value:n}).appendTo(i._valueContainer)}),i._valueContainer.appendTo(i.selectionContainer),"inner"!==a.selectionPosition||a.selectionContainer||(i.input.width(0),r=i.input.offset().left-i.selectionContainer.offset().left,n=i.container.width()-r-42,i.input.width(n)),l.length===a.maxSelection?g._updateHelper(a.maxSelectionRenderer.call(this,l.length)):i.helper.hide()},_selectItem:function(e){1===a.maxSelection&&(l=[]),i.addToSelection(e.data("json")),e.removeClass("ms-res-item-active"),!1!==a.expandOnFocus&&l.length!==a.maxSelection||i.collapse(),u?u&&(a.expandOnFocus||h)&&(g._processSuggestions(),h&&i.expand()):i.input.focus()},_sortAndTrim:function(t){var n=i.getRawValue(),r=[],s=[],o=i.getValue();return n.length>0?e.each(t,function(e,t){var i=t[a.displayField];(!0===a.matchCase&&i.indexOf(n)>-1||!1===a.matchCase&&i.toLowerCase().indexOf(n.toLowerCase())>-1)&&(!1!==a.strictSuggest&&0!==i.toLowerCase().indexOf(n.toLowerCase())||r.push(t))}):r=t,e.each(r,function(t,n){(a.allowDuplicates||-1===e.inArray(n[a.valueField],o))&&s.push(n)}),null!==a.sortOrder&&s.sort(function(e,t){return e[a.sortOrder]<t[a.sortOrder]?"asc"===a.sortDir?-1:1:e[a.sortOrder]>t[a.sortOrder]?"asc"===a.sortDir?1:-1:0}),a.maxSuggestions&&a.maxSuggestions>0&&(s=s.slice(0,a.maxSuggestions)),s},_group:function(t){return null!==a.groupBy&&(d={},e.each(t,function(e,t){var n=a.groupBy.indexOf(".")>-1?a.groupBy.split("."):a.groupBy,i=t[a.groupBy];if("string"!=typeof n)for(i=t;n.length>0;)i=i[n.shift()];void 0===d[i]?d[i]={title:i,items:[t]}:d[i].items.push(t)})),t},_updateHelper:function(e){i.helper.html(e),i.helper.is(":visible")||i.helper.fadeIn()},_validateSingleItem:function(e){if(null!==a.vregex&&a.vregex instanceof RegExp)return a.vregex.test(e);if(null!==a.vtype)switch(a.vtype){case"alpha":return/^[a-zA-Z_]+$/.test(e);case"alphanum":return/^[a-zA-Z0-9_]+$/.test(e);case"email":return/^(\w+)([\-+.][\w]+)*@(\w[\-\w]*\.){1,5}([A-Za-z]){2,6}$/.test(e);case"url":return/(((^https?)|(^ftp)):\/\/([\-\w]+\.)+\w{2,3}(\/[%\-\w]+(\.\w{2,})?)*(([\w\-\.\?\\\/+@&#;`~=%!]*)(\.\w{2,})?)*\/?)/i.test(e);case"ipaddress":return/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(e)}return!0}},f={_onBlur:function(){if(i.container.removeClass("ms-ctn-focus"),i.collapse(),u=!1,""!==i.getRawValue()&&!0===a.allowFreeEntries){var t={};t[a.displayField]=t[a.valueField]=i.getRawValue().trim(),i.addToSelection(t)}g._renderSelection(),!1===i.isValid()?i.container.addClass(a.invalidCls):""!==i.input.val()&&!1===a.allowFreeEntries&&(i.empty(),g._updateHelper("")),e(i).trigger("blur",[i])},_onComboItemMouseOver:function(t){var n=e(t.currentTarget);n.hasClass("ms-res-item-disabled")||(i.combobox.children().removeClass("ms-res-item-active"),n.addClass("ms-res-item-active"))},_onComboItemSelected:function(t){e(t.currentTarget).hasClass("ms-res-item-disabled")||g._selectItem(e(t.currentTarget))},_onFocus:function(){i.input.focus()},_onInputClick:function(){!1===i.isDisabled()&&u&&!0===a.toggleOnClick&&(a.expanded?i.collapse():i.expand())},_onInputFocus:function(){if(!1===i.isDisabled()&&!u){u=!0,i.container.addClass("ms-ctn-focus"),i.container.removeClass(a.invalidCls);var t=i.getRawValue().length;!0===a.expandOnFocus&&i.expand(),l.length===a.maxSelection?g._updateHelper(a.maxSelectionRenderer.call(this,l.length)):t<a.minChars&&g._updateHelper(a.minCharsRenderer.call(this,a.minChars-t)),g._renderSelection(),e(i).trigger("focus",[i])}},_onKeyDown:function(t){var n=i.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first"),r=i.input.val();if(e(i).trigger("keydown",[i,t]),t.keyCode!==m.TAB||!1!==a.useTabKey&&(!0!==a.useTabKey||0!==n.length||0!==i.input.val().length))switch(t.keyCode){case m.BACKSPACE:0===r.length&&i.getSelection().length>0&&"inner"===a.selectionPosition&&(l.pop(),g._renderSelection(),e(i).trigger("selectionchange",[i,i.getSelection()]),i.input.attr("placeholder","inner"===a.selectionPosition&&i.getValue().length>0?"":a.placeholder),i.input.focus(),t.preventDefault());break;case m.TAB:case m.ESC:t.preventDefault();break;case m.ENTER:(""!==r||a.expanded)&&t.preventDefault();break;case m.COMMA:!0===a.useCommaKey&&t.preventDefault();break;case m.CTRL:h=!0;break;case m.DOWNARROW:t.preventDefault(),g._moveSelectedRow("down");break;case m.UPARROW:t.preventDefault(),g._moveSelectedRow("up");break;default:l.length===a.maxSelection&&t.preventDefault()}else f._onBlur()},_onKeyUp:function(t){var n,r=i.getRawValue(),s=e.trim(i.input.val()).length>0&&(!a.maxEntryLength||e.trim(i.input.val()).length<=a.maxEntryLength),c={};if(e(i).trigger("keyup",[i,t]),clearTimeout(o),t.keyCode===m.ESC&&a.expanded&&i.combobox.hide(),t.keyCode===m.TAB&&!1===a.useTabKey||t.keyCode>m.ENTER&&t.keyCode<m.SPACE)t.keyCode===m.CTRL&&(h=!1);else switch(t.keyCode){case m.UPARROW:case m.DOWNARROW:t.preventDefault();break;case m.ENTER:case m.TAB:case m.COMMA:if(t.keyCode!==m.COMMA||!0===a.useCommaKey){if(t.preventDefault(),!0===a.expanded&&(n=i.combobox.find(".ms-res-item-active:not(.ms-res-item-disabled):first")).length>0)return void g._selectItem(n);!0===s&&!0===a.allowFreeEntries&&(c[a.displayField]=c[a.valueField]=r.trim(),i.addToSelection(c),i.collapse(),i.input.focus());break}default:l.length===a.maxSelection?g._updateHelper(a.maxSelectionRenderer.call(this,l.length)):r.length<a.minChars?(g._updateHelper(a.minCharsRenderer.call(this,a.minChars-r.length)),!0===a.expanded&&i.collapse()):a.maxEntryLength&&r.length>a.maxEntryLength?(g._updateHelper(a.maxEntryRenderer.call(this,r.length-a.maxEntryLength)),!0===a.expanded&&i.collapse()):(i.helper.hide(),a.minChars<=r.length&&(o=setTimeout(function(){!0===a.expanded?g._processSuggestions():i.expand()},a.typeDelay)))}},_onTagTriggerClick:function(t){i.removeFromSelection(e(t.currentTarget).data("json"))},_onTriggerClick:function(){if(!1===i.isDisabled()&&(!0!==a.expandOnFocus||l.length!==a.maxSelection))if(e(i).trigger("triggerclick",[i]),!0===a.expanded)i.collapse();else{var t=i.getRawValue().length;t>=a.minChars?(i.input.focus(),i.expand()):g._updateHelper(a.minCharsRenderer.call(this,a.minChars-t))}},_onWindowResized:function(){g._renderSelection()}};null!==t&&g._render(t)};e.fn.magicSuggest=function(n){var i=e(this);return 1===i.size()&&i.data("magicSuggest")?i.data("magicSuggest"):(i.each(function(i){var r=e(this);if(!r.data("magicSuggest")){"select"===this.nodeName.toLowerCase()&&(n.data=[],n.value=[],e.each(this.children,function(t,i){i.nodeName&&"option"===i.nodeName.toLowerCase()&&(n.data.push({id:i.value,name:i.text}),e(i).attr("selected")&&n.value.push(i.value))}));var s={};e.each(this.attributes,function(e,t){s[t.name]="value"===t.name&&""!==t.value?JSON.parse(t.value):t.value});var a=new t(this,e.extend([],e.fn.magicSuggest.defaults,n,s));r.data("magicSuggest",a),a.container.data("magicSuggest",a)}}),1===i.size()?i.data("magicSuggest"):i)},e.fn.magicSuggest.defaults={}}(jQuery);